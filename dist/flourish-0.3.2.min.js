function Flourish(a){var b={saveHistoryEntry:!0,replaceContents:!0,replaceBodyClasses:!0,replaceDelay:!1,replaceDocumentTitle:!0,replaceIgnoreClasses:[],bodyTransitionClass:"flourish-loading",childrenRemovingClass:"flourish-removing",childrenAddingClass:"flourish-adding",fileExt:["jpg","jpeg","bmp","gif","png","webp"]};this.options=this.extend(b,a||{}),this.fileRx=new RegExp(".("+this.options.fileExt.join("|")+")$","i"),"function"==typeof history.replaceState&&history.replaceState({url:location.href},"",location.href)}Flourish.prototype={pushStateOK:"function"==typeof history.pushState,events:{pre_fetch:[],post_fetch:[],post_replace:[]},on:function(a,b){return"function"==typeof b&&(void 0===this.events[a]&&(this.events[a]=[]),this.events[a].push(b)),this},off:function(a,b){var c,d=this.events[a];return d&&d.length&&("function"==typeof b?(c=d.indexOf(b),c>-1&&d.splice(c,1)):d.length=0),this},fire:function(a){var b=this.events[a];if(b&&b.length){var c=Array.prototype.slice.apply(arguments).slice(1);b.forEach(function(a){"function"==typeof a&&a.apply(a,c)})}return this},createDiv:function(a){var b=document.createElement("div");return b.innerHTML=a,b},getDocumentTitle:function(a){var b=a.match(/<title>([^\<]*?)<\/title>/i);return b&&b[1]?b[1].trim():""},getDocumentClasses:function(a){var b=a.match(/<html[^>]*>/i)[0],c=a.match(/<body[^>]*>/i)[0],d=b.match(/class=['|"](.*?)['|"]/i);d&&d[1]&&(d=d[1].trim());var e=c.match(/class=['|"](.*?)['|"]/i);return e&&e[1]&&(e=e[1].trim()),{html:d||"",body:e||""}},extend:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},fetch:function(a){var b=this;a=a||{},"string"==typeof a&&(a={url:a}),this.fire("pre_fetch",a);var c="function"==typeof a.onsuccess?a.onsuccess:this.onsuccess.bind(this),d="function"==typeof a.onerror?a.onerror:this.onerror.bind(this);if(!a||!a.url||this.fileRx.test(a.url))return!1;var e=new XMLHttpRequest;return e.open("GET",a.url,!0),e.onload=function(f){var g=d;return e.status>=200&&e.status<400&&(g=c),g(e,a,b)},e.onerror=d,e.send(),this},onsuccess:function(a,b,c){var d=a.responseText,e={title:this.getDocumentTitle(d),documentClasses:this.getDocumentClasses(d),el:this.createDiv(d)};return b=this.extend(this.extend({},this.options),b),this.fire("post_fetch",b,e,c),b.extractSelector&&(e.el=e.el.querySelector(b.extractSelector),!e.el)?(this.fire("selector_not_found_error",b.extractSelector),!1):(b.saveHistoryEntry&&"popstate"!==b.eventType&&this.addHistoryEntry({url:b.url}),b.replaceContents&&this.replaceContents(b,e),e)},onerror:function(a,b,c){console.error(a.status)},replaceContents:function(a,b,c){c&&(a=this.extend(this.extend({},this.options),a)),a.documentClasses=b.documentClasses;var d=document.querySelector(a.replaceSelector);if(d){var e=Number(a.replaceDelay);a.replaceDocumentTitle&&(document.querySelector("title").innerHTML=b.title);var f="replaceContentsNow";e&&(f="replaceContentsWithDelay"),this[f](a,d,b.el.children)}},replaceContentsNow:function(a,b,c){var d,e=document.querySelector("body"),f=a.replaceIgnoreClasses,g=b.children,h=[],i=[],j=0;if(a.replaceBodyClasses&&(e.className=a.documentClasses.body),a.bodyTransitionClass&&(e.className+=" "+a.bodyTransitionClass),f.length){for(len=g.length;len>0;)d=g[len-1],d&&(i=this.hasAnyClasses(d,f),0===i.length?b.removeChild(d):h=h.concat(i)),len--;for(len=c.length,j=0;len>0;)d=c[j],d&&(i=this.hasAnyClasses(d,h),0===i.length?b.appendChild(d):(d.parentNode.removeChild(d),j++)),len--}else{for(;g.length>0;)b.removeChild(g[j]);for(;c.length>0;)b.appendChild(c[j])}a.bodyTransitionClass&&this.removeClass(e,a.bodyTransitionClass),this.fire("post_replace")},replaceContentsWithDelay:function(a,b,d){var e,f=this,g=document.querySelector("body"),h=a.replaceIgnoreClasses,i=a.childrenRemovingClass,j=a.childrenAddingClass,k=b.children,l=k.length,m=[],n=[],o=0;if(a.bodyTransitionClass&&(g.className+=" "+a.bodyTransitionClass),i)for(;l>0;)e=k[l-1],e&&0===this.hasAnyClasses(e,h).length&&(e.className+=" "+i),l--;setTimeout(function(d){if(a.replaceBodyClasses&&(g.className=a.documentClasses.body),h.length){for(l=k.length;l>0;)e=k[l-1],e&&(n=f.hasAnyClasses(e,h),0===n.length?b.removeChild(e):m=m.concat(n)),l--;for(;d.length>0;)e=d[0],e&&(n=f.hasAnyClasses(e,m),0===n.length?(j&&(e.className+=" "+j),b.appendChild(e)):e.parentNode.removeChild(e))}else{for(;b.children.length>0;)b.removeChild(b.children[0]);try{for(;d.length>0;)j&&(d[0].className+=" "+j),b.appendChild(d[0])}catch(a){console.log(a,d),f.fire("replace_error",a)}}j&&setTimeout(function(){for(c=b.children,l=c.length,o=0;o<l;o++)f.removeClass(c[o],j);a.bodyTransitionClass&&f.removeClass(g,a.bodyTransitionClass)},25),f.fire("post_replace")},a.replaceDelay,d)},unique:function(a,b,c){return c.lastIndexOf(a)===b},hasAnyClasses:function(a,b){var c=a.className.split(/\s+/);return c.reduce(function(a,c){return b.indexOf(c)>-1&&a.push(c),a},[]).filter(this.unique)},removeClass:function(a,b){a&&a.className&&"string"==typeof a.className&&(a.className=a.className.split(" ").reduce(function(a,c){return c=c.trim(),c.length&&c!==b&&a.push(c),a},[]).join(" "))},addHistoryEntry:function(a){this.pushStateOK&&history.pushState(a,null,a.url)}};