function Flourish(e){var t={saveHistoryEntry:!0,replaceContents:!0,replaceBodyClasses:!0,replaceDelay:!1,replaceDocumentTitle:!0,replaceIgnoreClasses:[],bodyTransitionClass:"flourish-loading",childrenRemovingClass:"flourish-removing",childrenAddingClass:"flourish-adding",fileExt:["jpg","jpeg","bmp","gif","png","webp"]};this.options=this.extend(t,e||{}),this.fileRx=new RegExp(".("+this.options.fileExt.join("|")+")$","i"),"function"==typeof history.replaceState&&history.replaceState({url:location.href},"",location.href)}Flourish.prototype={version:"0.3.3",pushStateOK:"function"==typeof history.pushState,events:{pre_fetch:[],post_fetch:[],post_replace:[]},on:function(e,t){return"function"==typeof t&&(void 0===this.events[e]&&(this.events[e]=[]),this.events[e].push(t)),this},off:function(e,t){var s,n=this.events[e];return n&&n.length&&("function"==typeof t?(s=n.indexOf(t))>-1&&n.splice(s,1):n.length=0),this},fire:function(e){var t=this.events[e];if(t&&t.length){var s=Array.prototype.slice.apply(arguments).slice(1);t.forEach(function(e){"function"==typeof e&&e.apply(e,s)})}return this},createDiv:function(e){var t=document.createElement("div");return t.innerHTML=e,t},getDocumentTitle:function(e){var t=e.match(/<title>([^\<]*?)<\/title>/i);return t&&t[1]?t[1].trim():""},getDocumentClasses:function(e){var t=e.match(/<html[^>]*>/i)[0],s=e.match(/<body[^>]*>/i)[0],n=t.match(/class=['|"](.*?)['|"]/i);n&&n[1]&&(n=n[1].trim());var r=s.match(/class=['|"](.*?)['|"]/i);return r&&r[1]&&(r=r[1].trim()),{html:n||"",body:r||""}},extend:function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);return e},fetch:function(e){function t(t){return(this.status>=200&&this.status<400?n:r)(this,e,s)}var s=this;"string"==typeof(e=e||{})&&(e={url:e}),e.usePreloadedRequests=!0,this.fire("pre_fetch",e);var n="function"==typeof e.onsuccess?e.onsuccess:this.onsuccess.bind(this),r="function"==typeof e.onerror?e.onerror:this.onerror.bind(this);if(!e||!e.url||this.fileRx.test(e.url))return!1;if(e.usePreloadedRequests){var o=this.options.preloadedRequests,i=o&&o[e.url];if(i)return t.bind(i)(),this}var l=new XMLHttpRequest;return l.open("GET",e.url,!0),l.setRequestHeader("X-Requested-With","XMLHttpRequest"),l.onload=t,l.onerror=r,l.send(),this},onsuccess:function(e,t,s){var n=e.responseText,r={title:this.getDocumentTitle(n),documentClasses:this.getDocumentClasses(n),el:this.createDiv(n)};return t=this.extend(this.extend({},this.options),t),this.fire("post_fetch",t,r,s),t.extractSelector&&(r.el=r.el.querySelector(t.extractSelector),!r.el)?(this.fire("selector_not_found_error",t.extractSelector),!1):(t.saveHistoryEntry&&"popstate"!==t.eventType&&this.addHistoryEntry({url:t.url}),t.replaceContents&&this.replaceContents(t,r),r)},onerror:function(e,t,s){console.error(e.status)},replaceContents:function(e,t,s){s&&(e=this.extend(this.extend({},this.options),e)),e.documentClasses=t.documentClasses;var n=document.querySelector(e.replaceSelector);if(n){var r=Number(e.replaceDelay);e.replaceDocumentTitle&&(document.querySelector("title").innerHTML=t.title);var o="replaceContentsNow";r&&(o="replaceContentsWithDelay"),this[o](e,n,t.el.children)}},replaceContentsNow:function(e,t,s){var n,r=document.querySelector("body"),o=e.replaceIgnoreClasses,i=t.children,l=[],a=[],c=0;if(e.replaceBodyClasses&&(r.className=e.documentClasses.body),e.bodyTransitionClass&&(r.className+=" "+e.bodyTransitionClass),o.length){for(len=i.length;len>0;)(n=i[len-1])&&(0===(a=this.hasAnyClasses(n,o)).length?t.removeChild(n):l=l.concat(a)),len--;for(len=s.length,c=0;len>0;)(n=s[c])&&(0===(a=this.hasAnyClasses(n,l)).length?t.appendChild(n):(n.parentNode.removeChild(n),c++)),len--}else{for(;i.length>0;)t.removeChild(i[c]);for(;s.length>0;)t.appendChild(s[c])}e.bodyTransitionClass&&this.removeClass(r,e.bodyTransitionClass),this.fire("post_replace")},replaceContentsWithDelay:function(e,t,s){var n,r=this,o=document.querySelector("body"),i=e.replaceIgnoreClasses,l=e.childrenRemovingClass,a=e.childrenAddingClass,h=t.children,u=h.length,d=[],p=[],f=0;if(e.bodyTransitionClass&&(o.className+=" "+e.bodyTransitionClass),l)for(;u>0;)(n=h[u-1])&&0===this.hasAnyClasses(n,i).length&&(n.className+=" "+l),u--;setTimeout(function(s){if(e.replaceBodyClasses&&(o.className=e.documentClasses.body),i.length){for(u=h.length;u>0;)(n=h[u-1])&&(0===(p=r.hasAnyClasses(n,i)).length?t.removeChild(n):d=d.concat(p)),u--;for(;s.length>0;)(n=s[0])&&(0===(p=r.hasAnyClasses(n,d)).length?(a&&(n.className+=" "+a),t.appendChild(n)):n.parentNode.removeChild(n))}else{for(;t.children.length>0;)t.removeChild(t.children[0]);try{for(;s.length>0;)a&&(s[0].className+=" "+a),t.appendChild(s[0])}catch(e){console.log(e,s),r.fire("replace_error",e)}}a&&setTimeout(function(){for(c=t.children,u=c.length,f=0;f<u;f++)r.removeClass(c[f],a);e.bodyTransitionClass&&r.removeClass(o,e.bodyTransitionClass)},25),r.fire("post_replace")},e.replaceDelay,s)},unique:function(e,t,s){return s.lastIndexOf(e)===t},hasAnyClasses:function(e,t){return e.className.split(/\s+/).reduce(function(e,s){return t.indexOf(s)>-1&&e.push(s),e},[]).filter(this.unique)},removeClass:function(e,t){e&&e.className&&"string"==typeof e.className&&(e.className=e.className.split(" ").reduce(function(e,s){return(s=s.trim()).length&&s!==t&&e.push(s),e},[]).join(" "))},addHistoryEntry:function(e){this.pushStateOK&&history.pushState(e,null,e.url)}};